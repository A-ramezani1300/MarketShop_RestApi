#!/bin/bash
# wait-for-it.sh
# این اسکریپت منتظر می‌ماند تا یک سرویس (هاست:پورت) در دسترس قرار گیرد.

set -e # اگر هر دستوری با خطا مواجه شد، اسکریپت متوقف شود.

host="$1" # اولین آرگومان: نام هاست (مثلاً postgres یا redis)
shift     # آرگومان اول را حذف می‌کند
port="$1" # دومین آرگومان: شماره پورت (مثلاً 5432 یا 6379)
shift     # آرگومان دوم را حذف می‌کند
cmd="$@"  # بقیه آرگومان‌ها: دستور اصلی که باید بعد از آماده شدن سرویس اجرا شود

# حلقه تا زمانی که پورت باز شود
until nc -z "$host" "$port"; do
  >&2 echo "Service at $host:$port is unavailable - sleeping" # پیام خطا به stderr
  sleep 1 # یک ثانیه صبر می‌کند
done

>&2 echo "Service at $host:$port is up - executing command" # پیام موفقیت به stderr
exec $cmd # دستور اصلی را اجرا می‌کند و فرآیند اسکریپت را با آن جایگزین می‌کند
